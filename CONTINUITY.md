Goal: Deliver cannabis-only official pipeline (discovery/doc-hunt/evidence gating) without touching location logic.
State: checkpoint=.checkpoints/20260121-232254.patch; CI=PASS; Smoke=0/0
Done: CI determinism free-port + smoke contract checks; registry rebuild + missing_sources unification; checkpoint state fix + ledger compact dedupe; machine_verified evidence contract test; OCR/status-claim multi-doc aggregation marked done; wiki trust badge wired from links_trust; wiki refresh SSOT pipeline + offline metrics + MV write guard; network defaults online + wiki ingest/refresh fixes + official scope from portals/allowlist; AGENTS policy updated to allow git ops via commit_if_green and standard responses; data/laws edits allowed without approval via gate; final_response_only guard opt-in only; ci-local supports explicit smoke skip via ALLOW_SMOKE_SKIP=1 with SMOKE_MODE=skip; wiki refresh supports explicit offline fallback via ALLOW_WIKI_OFFLINE=1; quality_gate compares pre/post status instead of requiring empty tree; quality_gate ignores allowed artifacts (ci-final.txt, CONTINUITY.md, Reports/.checkpoints/source_snapshots/backups); quality_gate ignores data/wiki outputs from pass_cycle; commit_if_green stages all changes after gate; removed Next-line generation from CI/ledger output and added guards to block Next lines; stdout contract blocks placeholder lines and sanitizes ci-final output; wiki sync_all + official_badges CLI + new wiki refs/badges files; commit_if_green clears index.lock before commit and bails on unwritable git dir; wiki_claims snapshot supports map format; scheduled wiki sync workflow added; wiki refresh prints NET_MODE/WIKI_MODE and emits FETCH_DIAG on fetch failure; wiki claims ingest adds row_ref + notes_text; sync_all emits WIKI_SYNC (249) + OFFICIAL_BADGE metrics and WIKI_LINKS; official_badges emits OFFICIAL_BADGE totals + per-geo spotlight logs; web API now reads wiki ssot claims from map payload; pass_cycle netcheck reports NET_MODE/WIKI_MODE/NETWORK_DISABLED/WIKI_NETCHECK/OFFLINE and only marks OFFLINE on real net failure; commit_if_green supports -m/--tag args and prod tag override; wiki rec/med parsing fixed for illegal status; offline verify now loads cached refs and reports official/non-official counts; RU blocked only when RU_BLOCKED=1; MV counters align with EMPTY_WRITE_GUARD; wiki claims/refs maps regenerated with fixture refs for target geos; NET_HEALTH probe added with online/offline classification; wiki refresh uses NET_HEALTH gate; snapshot candidates logged per geo; run_checked_verify forces NETWORK for verify; non-official refs allowed for snapshot validation; wiki_claims_store prefers wiki_claims_map for rec/med; pass_cycle step-timeout helper logs STEP_BEGIN/END/TIMEOUT; wiki refresh uses refs cache window to avoid long ref extraction; verify_from_wiki now uses MediaWiki API + wikitext parser + cache-by-revision with WIKI_CACHE/WIKI_ROW logs; map UI scaffolding with Leaflet component, map APIs, and local data helpers added; net_health script added and pass_cycle uses it for OFFLINE classification; sync_legality + mark_official_refs scripts added; LeafletMap and mapData TS fixes applied; checked_verify default limit set to 8 in pass_cycle; wiki parser handles template statuses (including Hs|1 and Hs|0.1) and emits WIKI_PICK for US-CA; API/CLI now prefer wiki_claims_map SSOT; geo resolver logs US adm1 mapping; wiki CLI root guard + run.mjs entrypoint added; wiki_claim_gate + baseline added; wiki_claim_gate wired into pass_cycle/quality_gate; WIKI_OFFLINE_OK cache-allowed ping added; wiki_claim_gate baseline strict toggle added; pass_cycle cache-aware offline allowance added; wiki_claim_gate prints WIKI_GATE header/infographic and WIKI_GATE_OK with only the 5-line block; commit_if_green enforces WIKI_GATE_OK=1 and strict 5-line geo block from Reports/ci-final.txt; pass_cycle adds OFFLINE_DECISION and cache-aware ci_local offline allowance; ci-local prints failure diagnostics and writes Reports/ci_local_fail.txt; commit_if_green enforces ci_local rc=0 in ci-final; pass_cycle writes SSOT Reports/ci-final.txt with WIKI_GATE block; commit_if_green adds git writability diagnostics, lock cleanup, escalation gate, dry-run mode, ignores chmod failures, and enforces annotated tag creation/push with TAG_CREATED/TAG_PUSHED log lines; pass_cycle adds OFFLINE_REASON/MV_BLOCKED_REASON lines and requires WIKI_OFFLINE_OK for offline cache allowance; net_health now records DNS/HTTPS probe data for OFFLINE gating; wiki_db_gate added for sources/official invariants in SSOT; MAP_ENABLED flag added for CI and Leaflet guarded via client MapSection to avoid server dynamic import errors; NET_HEALTH adds connect probe for truth; pass_cycle emits EGRESS_TRUTH and diag writes Reports/ci-final.txt; net_truth_gate added and wired into quality/commit gates; post_checks/swift_tests and hub_stage_report added.
Now: NET_HEALTH emits NET_DIAG_DNS + NET_HTTP_PROBE with JSON mode for pass_cycle parsing (dns_ok/dns_err/dns_ns/dns_diag_reason/dns_diag_hint/http_ok/http_status/http_reason/api_ok/api_status/api_reason/connect_ok/connect_err_raw/connect_reason/connect_target/fallback_ok/fallback_status/fallback_reason/fallback_target/source), and pass_cycle sets NET_MODE=ONLINE when any truth probe succeeds (WIKI_PING ok=1 or http_ok/api_ok/connect_ok/fallback_ok=1; DNS is diagnostic only); CONNECT EPERM/EACCES classified as SANDBOX_EGRESS_BLOCKED (diag only) and connect_reason/connect_err_raw recorded in NET_DIAG; dns_diag_reason/hint classify ENOTFOUND + private resolver as SANDBOX_DNS_STUB and missing resolver as NO_DNS_CONFIG; NET_HEALTH reason is OK or HTTP_API_CONNECT_FALLBACK_FAIL; net_health --json always exits 0 and honors NET_PROBE_CACHE_PATH, emitting source=CACHE_FILE for cache reads and backfilling connect_reason/connect_err_raw; pass_cycle prints NET_DIAG json with dns/http/api/connect/fallback plus cache_ok/cache_age_h/max_cache_h/source fields and WIKI_REACHABILITY status in SSOT and adds NET_HEALTH dns_diag info; pass_cycle sets NET_MODE=ONLINE|DEGRADED_CACHE|OFFLINE based on probes (ONLINE only on probes; DEGRADED_CACHE when probes fail but cache is fresh) and uses cache-only mode for wiki sync when DEGRADED_CACHE; OFFLINE_DECISION reports online=1 only for probe success and reason=OK|CACHE_OK|CACHE_STALE|NO_CACHE, includes source and dns_diag_reason; OFFLINE_REASON is only set when offline=1 and uses HTTP/TLS/TIMEOUT/CONN_REFUSED/NO_ROUTE; pass_cycle writes EGRESS_TRUTH (with source) and DIAG_FAST now writes Reports/ci-final.txt; pass_cycle defaults NET_ENABLED=1 unless explicit env override and logs OVERRIDE_NETWORK; pass_cycle forbids FETCH_NETWORK flips within a run (NETWORK_FLIP guard); pass_cycle --diag runs /etc/resolv.conf + scutil --dns + node tools/net/dns_diag.mjs --json; WIKI_PING is reachability-only (OFFLINE does not depend on ping when cache is valid) and OFFLINE_CONTRADICTION guard fails when offline=1 but probes show online; WIKI_PING line includes status/reason/err; pass_cycle supports DIAG_FAST for --diag (net health + ping + wiki_claim_gate only) and exits early; quality_gate prints NET_FLAGS with defaults to SSOT, seeds NET_PROBE_CACHE_PATH and runs net_health once before net_truth_gate, then pass_cycle --diag before full pass_cycle and enforces NETWORK_FLIP ok=1; commit_if_green runs net_truth_gate and quality_gate before git ops; net_truth_gate runs net_health directly (no SSOT read), emits EGRESS_TRUTH + NET_DIAG json with allow/fetch/override flags (defaults to enabled), and never fails; NET_PROBE_CACHE_PATH reuses probes within a run; WIKI_TOTAL_DIAG printed in wiki_claim_gate with expected/found totals and gate fails on mismatch; sync_legality now logs WIKI_COUNTRIES_COUNT/WIKI_STATES_COUNT/WIKI_TOTAL alongside WIKI_SYNC and writes notes field (notes_text alias) in per-geo records; inspect_wiki_shapes.mjs outputs CLAIMS_COUNTRIES/CLAIMS_STATES/TOTAL and MAP_KEYS/MISSING_IN_MAP with mismatch exit; NO_PROGRESS_STRICT=0 allows wiki_db mode to continue on no-progress streaks when WIKI_GATE_OK=1; ci-local now skips entirely with CI_LOCAL_SKIP/CI_LOCAL_RESULT when CI_LOCAL_OFFLINE_OK=1 (offline cache) and reports CI_LOCAL_RESULT/CI_LOCAL_SKIP in SSOT; mediawiki_api supports pageid+revision fetch and wikitext cache by revision; sync_legality supports --smoke/--all/--all-countries, writes notes_text_len/sources_count, merges smoke updates into existing map, records pageid+revision in meta, writes per-geo JSON files, supports WIKI_CACHE_ONLY for cache-only runs, and falls back to existing map/meta in cache-only mode when cache files are missing; state mapping includes full 50-state fallback list; full sync outputs WIKI_SYNC mode=all countries_count=249 states_count=50 total=300; mark_official_refs writes wiki_claims_enriched and wiki_official_eval with per-geo totals from allowlist only and adds notes map to wiki_claims_enriched; wiki_official_eval summarizes enriched refs and emits OFFICIAL_BADGE totals plus OFFICIAL_BADGE_TOTALS; pass_cycle runs sync_legality --smoke and appends OFFICIAL_BADGE line and OFFICIAL_BADGE_TOTALS to SSOT; pass_cycle runs cron_sync_all when WIKI_GATE_OK=1 and NET_MODE!=OFFLINE, then re-runs mark_official_refs --all and appends WIKI_SYNC_ALL into SSOT; cron_sync_all.sh now uses env var arrays for CACHE_ONLY vs ONLINE and emits WIKI_SYNC_ALL total_countries/states/total/revision/changed/duration/mode/rc and exits nonzero on failure; pass_cycle prints PIPELINE_NET_MODE and WIKI_REFRESH_MODE in SSOT and stdout; commit_if_green now runs git_health (GIT_HEALTH ok/reason/details), writes blocked artifacts on PERM/SANDBOX/LOCK, writes Artifacts/git_bundle/<RUN_ID>/changes.patch + status.txt + APPLY_AND_PUSH.sh with GIT_BUNDLE_READY/GIT_BUNDLE_APPLY/GIT_BUNDLE_PATCH lines, exits nonzero on git EPERM (GIT_AUTOCOMMIT=0), and prints TAG_CREATED/TAG_PUSHED in stdout; pass_cycle auto-invokes commit_if_green after WIKI_SYNC_ALL and treats GIT_AUTOCOMMIT=0 as COMMIT_ATTEMPT=GIT_BLOCKED without failing the run; commit_if_green uses git check-ignore for Artifacts/git_blocked and stages only tools/**, data/wiki/**, README.md, CONTINUITY.md, .gitignore, and prints GIT_TREE_CLEAN; pass_cycle now writes run-scoped SSOT in Artifacts/runs/<RUN_ID>/ci-final.txt, copies to Reports/ci-final.txt only after summary, and appends commit results to run-scoped report before syncing; hub_stage_report prints REPORT_MTIME/RUN_ID, STALE_SSOT, WHERE_SSOT, and reads run-scoped SSOT when Reports/ci-final.txt is stale.
WIP: UNCONFIRMED local untracked work pending manual merge; safety snapshot captured.
Open questions: UNCONFIRMED preferred tone for provisional/needs_review banners in UI â€” owner: Vitaliy, due 2026-01-15.
